```markdown
# 80_packages.md — Работа с packages/

## Назначение packages/

Директория `packages/` содержит код, который используется как в мобильном приложении, так и (потенциально) в веб-версии. Это ядро переиспользуемой логики и компонентов.

## Структура packages/

```
packages/
├── design-tokens/        # Дизайн-система (цвета, типографика)
├── entities/             # Бизнес-сущности (см. 10_entities.md)
├── features/             # Общая бизнес-логика между модулями
├── functions/            # Чистые функции-хелперы
├── shared-components/    # Сложные UI-компоненты (LEGACY, НЕ ТРОГАТЬ)
├── shared-ui/            # Примитивные UI-компоненты (LEGACY, НЕ ТРОГАТЬ)
└── widgets/              # Блоки страниц со своей логикой
```

## Правила работы с packages/

### 1. Запрет на изменение legacy кода

Директории `shared-components/` и `shared-ui/` содержат устаревший код, который поддерживается только в режиме совместимости.

**НЕЛЬЗЯ:**
- Редактировать существующие компоненты в shared-components и shared-ui
- Удалять файлы из этих директорий
- Создавать там новые компоненты
- Рефакторить код в этих папках

**МОЖНО:**
- Использовать существующие компоненты в новом коде
- Создавать новые компоненты ТОЛЬКО в новых директориях (widgets, entities, features)

### 2. Создание нового кода

Новые компоненты и логику создаем в:
- `packages/entities/` — новые сущности
- `packages/features/` — новая общая логика
- `packages/widgets/` — новые сложные блоки
- `packages/functions/` — новые вспомогательные функции

### 3. Импорты внутри packages/

**Правила:**
- Модули внутри packages могут импортировать друг друга
- Нельзя создавать циклические зависимости
- Импорты всегда через алиас `@packages/`

```typescript
// Правильно
import { Button } from '@packages/shared-ui/button'
import { UserEntity } from '@packages/entities/user'
import { formatDate } from '@packages/functions/format-date'

// Неправильно
import { Button } from '../shared-ui/button'
import { UserEntity } from '../../../packages/entities/user'
```

### 4. Структура новой директории в packages/

При создании новой папки в packages соблюдаем единообразие:

```
packages/[category]/[name]/
├── index.ts              # Публичное API (обязательно)
├── types.ts              # Типы (если есть)
├── [name].ts             # Основной файл
├── [name]-api.ts         # API запросы (если нужно)
├── [name]-store.ts       # MobX store (если нужно)
├── [name]-utils.ts       # Утилиты (если нужно)
└── __tests__/            # Тесты (опционально)
```

### 5. Экспорты

Каждый модуль в packages обязан иметь `index.ts`, который явно декларирует публичное API:

```typescript
// packages/features/notifications/index.ts

// Экспортируем только то, что должны видеть другие модули
export { sendNotification, markAsRead } from './notifications-api'
export type { Notification, NotificationType } from './types'

// НЕ экспортируем внутренние утилиты, хелперы, константы
```

### 6. Версионирование (для будущего)

Код в packages не версионируется отдельно — он часть основного репозитория. 
При обратно несовместимых изменениях создаем новую версию рядом со старой:

```
packages/features/
├── notifications/        # Старая версия
└── notifications-v2/     # Новая версия с изменениями API
```

### 7. Типизация

Весь код в packages пишется на TypeScript с строгой типизацией.
Запрещено использовать `any` без явного обоснования.

### 8. Функции в packages/functions/

В `packages/functions/` хранятся только чистые функции без сайд-эффектов:
- Форматирование дат
- Валидация данных
- Преобразование структур
- Математические расчеты

**НЕЛЬЗЯ** помещать в functions:
- Запросы к API
- Работу с DOM/UI
- Состояния (state)

### 9. Работа с существующими сущностями

При добавлении новых полей или методов в существующую сущность:
- Не удалять старые поля/методы
- Помечать устаревшее как `@deprecated`
- Создавать новые файлы, не изменяя старые без крайней необходимости

### 10. Рефакторинг

Если требуется глобальное изменение в packages:
1. Создать задачу на рефакторинг
2. Согласовать с архитектором
3. Создать новую структуру параллельно со старой
4. Поэтапно переводить потребителей на новую версию
5. Удалять старый код только когда все потребители переведены

## Краткий чек-лист при работе с packages

- [ ] Я не изменяю legacy код в shared-components и shared-ui
- [ ] Я создаю новые файлы, а не редактирую старые
- [ ] У новой сущности есть index.ts с явными экспортами
- [ ] Импорты идут через алиас @packages/
- [ ] Код типизирован, нет any
- [ ] Функции в packages/functions/ чистые
```